---
import PageLayout from "@/layouts/Base.astro";
import ShowCard from "@/components/ShowCard.astro";
import { getTVShows } from "@/lib/tmdb";
import { getWatchHistory } from "@/data/watch-history";

const meta = {
	description: "TV shows I've watched and enjoyed",
	title: "TV Shows",
};

// Load watch history (from Trakt if configured, otherwise manual data)
const watchHistory = await getWatchHistory();

// Fetch TV shows for each year with their watch entry metadata
const showsByYear = await Promise.all(
	watchHistory.map(async (yearGroup) => {
		// Filter to only TV entries with notes
		const showEntries = yearGroup.entries.filter((entry) => entry.type === "tv" && entry.notes);

		// Get unique show IDs
		const showIds = [...new Set(showEntries.map((entry) => entry.tmdbId))];
		const shows = await getTVShows(showIds);

		// Create a map of TMDB ID to entry for quick lookup
		const entryMap = new Map(showEntries.map((entry) => [entry.tmdbId, entry]));

		// Combine TMDB data with watch entry metadata
		const showsWithMetadata = shows.map((show) => {
			const entry = entryMap.get(show.id);
			return {
				...show,
				notes: entry?.notes || "",
				rating: entry?.rating,
			};
		});

		return {
			year: yearGroup.year,
			shows: showsWithMetadata,
		};
	}),
);

// Filter out years with no shows
const yearsWithShows = showsByYear.filter((group) => group.shows.length > 0);
---

<PageLayout meta={meta}>
	<div class="w-full">
		<div class="mb-8">
			<h1 class="title mb-4">TV Shows</h1>
			<p class="text-gray-600 dark:text-gray-400">
				A collection of TV shows I've watched, organized by year. Data from{" "}
				<a
					href="https://www.themoviedb.org"
					class="cactus-link"
					target="_blank"
					rel="noopener noreferrer">The Movie Database</a
				>.
			</p>
		</div>

		{
			yearsWithShows.length > 0 ? (
				<div class="space-y-12">
					{yearsWithShows.map(({ year, shows }) => (
						<section>
							<h2 class="mb-6 text-2xl font-bold text-gray-900 dark:text-gray-100">{year}</h2>
							<div class="grid gap-6 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4">
								{shows.map((show) => (
									<ShowCard
										name={show.name}
										posterPath={show.poster_path}
										firstAirDate={show.first_air_date}
										notes={show.notes}
										rating={show.rating}
									/>
								))}
							</div>
						</section>
					))}
				</div>
			) : (
				<div class="rounded-lg border border-gray-200 bg-gray-50 p-8 text-center dark:border-gray-700 dark:bg-gray-800">
					<p class="text-gray-600 dark:text-gray-400">
						{import.meta.env.TMDB_API_KEY
							? "No TV shows found. Check the console for errors."
							: "TMDB API key is not configured. Please add TMDB_API_KEY to your .env file."}
					</p>
				</div>
			)
		}
	</div>
</PageLayout>
