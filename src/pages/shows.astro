---
import PageLayout from "@/layouts/Base.astro";
import ShowCard from "@/components/ShowCard.astro";
import { getTVShows } from "@/lib/tmdb";
import { watchHistory, getTVShowIdsByYear } from "@/data/watch-history";

const meta = {
	description: "TV shows I've watched and enjoyed",
	title: "TV Shows",
};

// Fetch TV shows for each year
const showsByYear = await Promise.all(
	watchHistory.map(async (yearGroup) => {
		const showIds = getTVShowIdsByYear(yearGroup.year);
		const shows = await getTVShows(showIds);
		return {
			year: yearGroup.year,
			shows,
		};
	}),
);

// Filter out years with no shows
const yearsWithShows = showsByYear.filter((group) => group.shows.length > 0);
---

<PageLayout meta={meta}>
	<div class="w-full">
		<div class="mb-8">
			<h1 class="title mb-4">TV Shows</h1>
			<p class="text-gray-600 dark:text-gray-400">
				A collection of TV shows I've watched, organized by year. Data from{" "}
				<a
					href="https://www.themoviedb.org"
					class="cactus-link"
					target="_blank"
					rel="noopener noreferrer">The Movie Database</a
				>.
			</p>
		</div>

		{
			yearsWithShows.length > 0 ? (
				<div class="space-y-12">
					{yearsWithShows.map(({ year, shows }) => (
						<section>
							<h2 class="mb-6 text-2xl font-bold text-gray-900 dark:text-gray-100">{year}</h2>
							<div class="grid gap-6 sm:grid-cols-2 lg:grid-cols-3">
								{shows.map((show) => (
									<ShowCard
										name={show.name}
										posterPath={show.poster_path}
										firstAirDate={show.first_air_date}
										rating={show.vote_average}
										overview={show.overview}
										numberOfSeasons={show.number_of_seasons}
										numberOfEpisodes={show.number_of_episodes}
									/>
								))}
							</div>
						</section>
					))}
				</div>
			) : (
				<div class="rounded-lg border border-gray-200 bg-gray-50 p-8 text-center dark:border-gray-700 dark:bg-gray-800">
					<p class="text-gray-600 dark:text-gray-400">
						{import.meta.env.TMDB_API_KEY
							? "No TV shows found. Check the console for errors."
							: "TMDB API key is not configured. Please add TMDB_API_KEY to your .env file."}
					</p>
				</div>
			)
		}
	</div>
</PageLayout>
