---
import PageLayout from "@/layouts/Base.astro";
import MovieCard from "@/components/MovieCard.astro";
import { getMovies } from "@/lib/tmdb";
import { getWatchHistory } from "@/data/watch-history";

const meta = {
	description: "Movies I've watched and enjoyed",
	title: "Movies",
};

// Load watch history (from Trakt if configured, otherwise manual data)
const watchHistory = await getWatchHistory();

// Fetch movies for each year with their watch entry metadata
const moviesByYear = await Promise.all(
	watchHistory.map(async (yearGroup) => {
		// Filter to only movie entries with notes
		const movieEntries = yearGroup.entries.filter(
			(entry) => entry.type === "movie" && entry.notes,
		);

		// Get unique movie IDs
		const movieIds = [...new Set(movieEntries.map((entry) => entry.tmdbId))];
		const movies = await getMovies(movieIds);

		// Create a map of TMDB ID to entry for quick lookup
		const entryMap = new Map(movieEntries.map((entry) => [entry.tmdbId, entry]));

		// Combine TMDB data with watch entry metadata
		const moviesWithMetadata = movies.map((movie) => {
			const entry = entryMap.get(movie.id);
			return {
				...movie,
				notes: entry?.notes || "",
				rating: entry?.rating,
			};
		});

		return {
			year: yearGroup.year,
			movies: moviesWithMetadata,
		};
	}),
);

// Filter out years with no movies
const yearsWithMovies = moviesByYear.filter((group) => group.movies.length > 0);
---

<PageLayout meta={meta}>
	<div class="w-full">
		<div class="mb-8">
			<h1 class="title mb-4">Movies</h1>
			<p class="text-gray-600 dark:text-gray-400">
				A collection of movies I've watched, organized by year. Data from{" "}
				<a
					href="https://www.themoviedb.org"
					class="cactus-link"
					target="_blank"
					rel="noopener noreferrer">The Movie Database</a
				>.
			</p>
		</div>

		{
			yearsWithMovies.length > 0 ? (
				<div class="space-y-12">
					{yearsWithMovies.map(({ year, movies }) => (
						<section>
							<h2 class="mb-6 text-2xl font-bold text-gray-900 dark:text-gray-100">{year}</h2>
							<div class="grid gap-6 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4">
								{movies.map((movie) => (
									<MovieCard
										title={movie.title}
										posterPath={movie.poster_path}
										releaseDate={movie.release_date}
										notes={movie.notes}
										rating={movie.rating}
									/>
								))}
							</div>
						</section>
					))}
				</div>
			) : (
				<div class="rounded-lg border border-gray-200 bg-gray-50 p-8 text-center dark:border-gray-700 dark:bg-gray-800">
					<p class="text-gray-600 dark:text-gray-400">
						{import.meta.env.TMDB_API_KEY
							? "No movies found. Check the console for errors."
							: "TMDB API key is not configured. Please add TMDB_API_KEY to your .env file."}
					</p>
				</div>
			)
		}
	</div>
</PageLayout>
